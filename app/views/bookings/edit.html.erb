<%= p session[:check] %>
<%= p @proposed.start_date %>
<% array_of_weeks = calendar(@date) %>
<% start_date = @booking.start_date %>
<% end_date = @booking.end_date %>
<% booked_dates = find_bookings(@bookings) %> <!--returns a hash of booked dates and the associated user for each booked date.-->
<% proposed_dates = (start_date..end_date).to_a %>
<% booked_dates = remove_proposed(booked_dates, proposed_dates) %>
<% booked_dates_array = booked_array(booked_dates) %>
<% conflicting_dates = booked_dates_array & (@proposed.start_date..@proposed.end_date).to_a %>
<% proposed_dates = (@proposed.start_date..@proposed.end_date).to_a if session[:check] %>
<h2 id="month">
    <%= link_to "<", {date: @date.prev_month, bookable: @booking.bookable_type, (@booking.bookable_type.downcase + "_id").to_sym => @booking.bookable_id} %>
    <%= @date.strftime("%B %Y") %>
    <%= link_to ">", {date: @date.next_month, bookable: @booking.bookable_type, (@booking.bookable_type.downcase + "_id").to_sym => @booking.bookable_id} %>
</h2>
<table id="booking-calendar">
	<%= render 'days' %>
	<% array_of_weeks.map do |week| %>
		<tr>
			<% week.map do |date| %>
				<%= content_tag :td, class: day_classes(date, @date, booked_dates, proposed_dates) do %>
					<%= date.day %>
					<br>
					<% if booked_dates.member?(date) %>
						<p>Booked</p>
						<%= booked_dates.fetch(date) %> <!--fetches the identity of the user that booked the equipment on that date.-->				
					<% elsif proposed_dates.include?(date) %>
							<% if session[:check] %>
								<span>Revised</span>
							<% else %>
							  <span>Current</span> 
							<% end %>
							<p>Trial Date</p>
					<% end %>
				<% end %>
			<% end %>
		</tr>
	<% end %>
</table>






<% if session[:check] == nil || !conflicting_dates.empty? %>
	<% if !conflicting_dates.empty? %>
		<p>There is a conflict. The following dates are not available:</p>
		<% conflicting_dates.each do |date| %>
	  	<%= date %>
		<% end %>
	<% end %>
	<%= form_for :booking, url: edit_user_booking_path, method: :get do |f| %>
	<%= f.hidden_field :bookable, value: @booking.bookable_type %>
	<%= f.hidden_field :id, value: @booking.bookable_id %>
	<%= f.hidden_field :booking_id, value: @booking.id %>
	<%= f.hidden_field :check, value: true %>
	<%= f.date_field :start_date %>
	<%= f.date_field :end_date %>
	<%= f.submit "Check Dates" %>
	<% end %>
<% elsif session[:check] && conflicting_dates.empty? %>
	<%= link_to "Change Dates", update_user_booking_path(booking: { start_date: @proposed.start_date, end_date: @proposed.end_date}, id: @booking.id), method: :patch, class: "btn btn-primary btn-lg" %>
<% end %>


 


# THIS WORKS!!!! Just write the check_dates function and then 
# replace "let's submit this bitch" with another link to the 
# update action where it will update the booking and reset the 
# session variable (delete it). Also implement dumbed down version 
# of the calendar above the form so user can see available dates.